---
title: "Mælabord"
author: "The North"
date: "2024-11-06"
output: html_document
---


```{r}
# Hlaða nauðsynlegum bókasöfnum
library(shiny)
library(dplyr)
library(tidyr)
library(ggplot2)
library(DBI)
library(RSQLite)
library(stringr)

# Tengist SQLite gagnagrunninum og sækir gögn um Leonardo DiCaprio og Kate Winslet
conn <- dbConnect(SQLite(), "C:\\Users\\Ásdís\\OneDrive - Kvennaskolinn i Reykjavik\\Desktop\\Documents\\HÍ haust 24\\Upplýsingaverkfræði\\capstone-the-north\\data\\rotten_tomatoes.db")
actors_info <- dbGetQuery(conn, "
  SELECT name, headshot, mini_biography
  FROM actors_info1
  WHERE name IN ('Leonardo DiCaprio', 'Kate Winslet')
")
dbDisconnect(conn)

# Skilgreinir fall til að stytta texta eftir 6 setningar
shorten_biography <- function(bio) {
  sentences <- str_split(bio, "\\.")[[1]]
  shortened <- paste(sentences[1:min(6, length(sentences))], collapse = ". ")
  return(paste0(shortened, "."))
}

# Styttir lýsingar fyrir báða leikarana
actors_info$short_bio <- sapply(actors_info$mini_biography, shorten_biography)

# Búa til nýja dálka með ártalinu og mánuðinum fyrir Leonardo og Kate
kate_movies <- rotten_tomatoes_leo_kate %>%
  filter(grepl("Kate Winslet", actors)) %>%
  mutate(
    release_date = as.Date(original_release_date, format = "%Y-%m-%d"),
    release_year = as.numeric(format(release_date, "%Y")),
    release_month = as.numeric(format(release_date, "%m")),
    short_movie_info = gsub("^(([^.]*\\.){2}).*", "\\1", movie_info)
  )

leo_movies <- rotten_tomatoes_leo_kate %>%
  filter(grepl("Leonardo DiCaprio", actors)) %>%
  mutate(
    release_date = as.Date(original_release_date, format = "%Y-%m-%d"),
    release_year = as.numeric(format(release_date, "%Y")),
    release_month = as.numeric(format(release_date, "%m")),
    short_movie_info = gsub("^(([^.]*\\.){2}).*", "\\1", movie_info)
  )

# Setjum upp Shiny UI með flipaskipulagi
ui <- fluidPage(
  titlePanel("Samanburður og yfirlit yfir kvikmyndir Leonardo DiCaprio og Kate Winslet"),
  
  tabsetPanel(
    tabPanel("Samanburður á einkunn", 
             sidebarLayout(
               sidebarPanel(
                 selectInput("genre", "Veldu tegund (genre):", choices = NULL, selected = "Overall")
               ),
               mainPanel(
                 plotOutput("ratingPlot")
               )
             )),
    tabPanel("Einkunnir og myndir yfir tíma",
             mainPanel(
               h3("Audience Ratings fyrir Kate Winslet yfir árin"),
               plotOutput("kateRatingPlot", hover = hoverOpts(id = "kate_hover")),
               uiOutput("kate_hover_info"),
               
               h3("Audience Ratings fyrir Leonardo DiCaprio yfir árin"),
               plotOutput("leoRatingPlot", hover = hoverOpts(id = "leo_hover")),
               uiOutput("leo_hover_info")
             )),
    tabPanel("Kynning á Leikurum",
             fluidRow(
               column(6,
                      h3(actors_info$name[1]),
                      img(src = actors_info$headshot[1], height = "200px"),
                      p(actors_info$short_bio[1])
               ),
               column(6,
                      h3(actors_info$name[2]),
                      img(src = actors_info$headshot[2], height = "200px"),
                      p(actors_info$short_bio[2])
               )
             ))
  )
)

# Server kóðinn
server <- function(input, output, session) {
  
  # Setja upp valmöguleika fyrir tegundir út frá gögnunum og bæta við "Overall"
  observe({
    genres <- unique(unlist(strsplit(as.character(rotten_tomatoes_leo_kate$genres), ",\\s*")))
    genres <- c("Overall", genres)
    updateSelectInput(session, "genre", choices = genres)
  })
  
  # Reikna meðaleinkunn og fjölda mynda fyrir hverja tegund og sýna grafið fyrir samanburð
  output$ratingPlot <- renderPlot({
    req(input$genre)
    
    if (input$genre == "Overall") {
      genre_data <- rotten_tomatoes_leo_kate %>%
        mutate(actor = case_when(
          grepl("Leonardo DiCaprio", actors) ~ "Leonardo DiCaprio",
          grepl("Kate Winslet", actors) ~ "Kate Winslet",
          TRUE ~ NA_character_
        )) %>%
        filter(!is.na(actor)) %>%
        group_by(actor) %>%
        summarize(avg_audience_rating = mean(audience_rating, na.rm = TRUE),
                  movie_count = n())
    } else {
      genre_data <- rotten_tomatoes_leo_kate %>%
        separate_rows(genres, sep = ",\\s*") %>%
        filter(genres == input$genre) %>%
        mutate(actor = case_when(
          grepl("Leonardo DiCaprio", actors) ~ "Leonardo DiCaprio",
          grepl("Kate Winslet", actors) ~ "Kate Winslet",
          TRUE ~ NA_character_
        )) %>%
        filter(!is.na(actor)) %>%
        group_by(actor) %>%
        summarize(avg_audience_rating = mean(audience_rating, na.rm = TRUE),
                  movie_count = n())
    }
    
    ggplot(genre_data, aes(x = actor, y = avg_audience_rating, fill = actor)) +
      geom_bar(stat = "identity") +
      geom_text(aes(label = paste0("Meðaltal: ", round(avg_audience_rating, 1), 
                                   "\nFjöldi mynda: ", movie_count)), 
                vjust = -0.3, size = 5) +
      ylim(0, 100) +
      labs(title = "Meðaltal á einkunn áhorfenda eftir tegund ásamt fjölda mynda",
           x = "Leikari",
           y = "Meðaleinkunn frá áhorfendum") +
      theme_minimal()
  })
  
  # Tímaraðargraf fyrir Kate Winslet með upplýsingum
  output$kateRatingPlot <- renderPlot({
    ggplot(kate_movies, aes(x = release_date, y = audience_rating)) +
      geom_line(color = "blue") +
      geom_point(color = "darkblue") +
      scale_x_date(date_labels = "%Y", date_breaks = "10 years") +
      labs(
        title = "Audience Ratings fyrir Kate Winslet yfir tíma",
        x = "Release Year",
        y = "Audience Rating"
      ) +
      theme_minimal() +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
      )
  })
  
  output$kate_hover_info <- renderUI({
    hover <- input$kate_hover
    if (!is.null(hover)) {
      point <- nearPoints(kate_movies, hover, xvar = "release_date", yvar = "audience_rating", threshold = 5)
      if (nrow(point) == 1) {
        wellPanel(
          h4(point$movie_title),
          p(point$short_movie_info),
          p(strong("Release Date: "), format(point$release_date, "%B %Y")),
          p(strong("Audience Rating: "), point$audience_rating)
        )
      }
    }
  })
  
  # Tímaraðargraf fyrir Leonardo DiCaprio með upplýsingum
  output$leoRatingPlot <- renderPlot({
    ggplot(leo_movies, aes(x = release_date, y = audience_rating)) +
      geom_line(color = "blue") +
      geom_point(color = "darkblue") +
      scale_x_date(date_labels = "%Y", date_breaks = "10 years") +
      labs(
        title = "Audience Ratings fyrir Leonardo DiCaprio yfir tíma",
        x = "Release Year",
        y = "Audience Rating"
      ) +
      theme_minimal() +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
      )
  })
  
  output$leo_hover_info <- renderUI({
    hover <- input$leo_hover
    if (!is.null(hover)) {
      point <- nearPoints(leo_movies, hover, xvar = "release_date", yvar = "audience_rating", threshold = 5)
      if (nrow(point) == 1) {
        wellPanel(
          h4(point$movie_title),
          p(point$short_movie_info),
          p(strong("Release Date: "), format(point$release_date, "%B %Y")),
          p(strong("Audience Rating: "), point$audience_rating)
        )
      }
    }
  })
}

# Keyra Shiny appið
shinyApp(ui = ui, server = server)


```
